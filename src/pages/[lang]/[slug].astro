---
import BaseLayout from "@layouts/BaseLayout.astro";
import { getEntry } from "astro:content";
import type { CollectionEntry } from "astro:content";
import { DEFAULT_LOCALE, SUPPORTED_LOCALES, resolveLocale } from "@lib/i18n/locales";
import {
  getLocalizedPage,
  getPageSlug,
  getPageTranslations,
} from "@lib/i18n/pages";
import { resolveSection } from "@lib/sectionRenderer";
import { getSiteConfig } from "@lib/siteData";

export async function getStaticPaths() {
  const translations = await getPageTranslations();
  const paths: Array<{ params: { lang: string; slug: string }; props: { translationKey: string } }> = [];

  for (const [translationKey, locales] of translations.entries()) {
    if (translationKey === "home") continue;

    for (const locale of SUPPORTED_LOCALES) {
      const entry = locales.get(locale) ?? locales.get(DEFAULT_LOCALE);
      if (!entry) continue;
      const slug = getPageSlug(entry);
      paths.push({
        params: {
          lang: locale,
          slug,
        },
        props: {
          translationKey,
        },
      });
    }
  }

  return paths;
}

interface Props {
  translationKey: string;
}

const { translationKey } = Astro.props as Props;

const requestedLocale = resolveLocale(Astro.params.lang);
const localizedPage = await getLocalizedPage(translationKey, requestedLocale);

if (!localizedPage) {
  return Astro.redirect("/", 307);
}

const { entry: page, locale, alternates } = localizedPage;
const site = getSiteConfig(locale);

const sectionEntries = await Promise.all(
  page.data.sections.map(async ({ slug }) => await getEntry("sections", slug)),
);

const validSections = sectionEntries.filter(
  (section): section is CollectionEntry<"sections"> => Boolean(section),
);

if (validSections.length !== sectionEntries.length) {
  console.warn(
    `Certaines sections référencées par la page "${translationKey}" (${locale}) sont introuvables et ont été ignorées.`,
  );
}

const resolvedSections = await Promise.all(validSections.map(resolveSection));
---

<BaseLayout
  title={page.data.title}
  description={page.data.description}
  seo={page.data.seo}
  lang={locale}
  site={site}
  alternates={alternates}
>
  {resolvedSections.map(({ Component, props }) => <Component {...props} />)}
</BaseLayout>
