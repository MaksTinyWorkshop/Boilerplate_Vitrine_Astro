---
import BaseLayout from "@layouts/BaseLayout.astro";
import { getCollection, getEntry } from "astro:content";
import { resolveSection } from "@lib/sectionRenderer";
import type { CollectionEntry } from "astro:content";
import { resolveLocale, localizePath } from "@lib/i18n/locales";
import { getSiteConfig } from "@lib/siteData";

export async function getStaticPaths() {
  const pages = await getCollection(
    "pages",
    ({ data }) => !data.draft && data.translationKey !== "home",
  );

  return pages.map((page) => {
    const slugFromFrontmatter = page.data.slug;
    const fallbackSlug = page.slug.split("/").slice(-1)[0] ?? page.slug;
    const slug = slugFromFrontmatter ?? fallbackSlug;

    return {
      params: {
        lang: page.data.lang,
        slug,
      },
      props: { page },
    };
  });
}

interface Props {
  page: CollectionEntry<"pages">;
}

const { page } = Astro.props as Props;

const paramsLocale = resolveLocale(Astro.params.lang);
const site = getSiteConfig(paramsLocale);

const sectionEntries = await Promise.all(
  page.data.sections.map(async ({ slug }) => await getEntry("sections", slug)),
);

const validSections = sectionEntries.filter(
  (section): section is CollectionEntry<"sections"> => Boolean(section),
);

if (validSections.length !== sectionEntries.length) {
  console.warn(
    `Certaines sections référencées par la page "${page.data.translationKey}" (${paramsLocale}) sont introuvables et ont été ignorées.`,
  );
}

const resolvedSections = await Promise.all(validSections.map(resolveSection));

const translationKey = page.data.translationKey;

const alternatePages = await getCollection(
  "pages",
  ({ data }) => !data.draft && data.translationKey === translationKey,
);

const alternates = alternatePages.map((entry) => {
  const slugFromFrontmatter = entry.data.slug;
  const fallbackSlug = entry.slug.split("/").slice(-1)[0] ?? entry.slug;
  const targetSlug = slugFromFrontmatter ?? fallbackSlug;
  const path = targetSlug ? `/${targetSlug}` : "/";

  return {
    locale: entry.data.lang,
    path,
    url: localizePath(path, entry.data.lang),
  };
});

---

<BaseLayout
  title={page.data.title}
  description={page.data.description}
  seo={page.data.seo}
  lang={paramsLocale}
  site={site}
  alternates={alternates}
>
  {resolvedSections.map(({ Component, props }) => <Component {...props} />)}
</BaseLayout>
