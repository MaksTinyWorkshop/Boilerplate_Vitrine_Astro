---
import { resolveUrl, isExternalUrl } from "@lib/urlHelpers";
import type { CTASectionProps } from "@app-types/cta";
import styles from "./ctaDownload.module.scss";

const {
  title,
  description,
  note,
  download,
  media,
  theme = "light",
  align = "center",
} = Astro.props as CTASectionProps;

if (!download) {
  throw new Error("CTA download section requires a download configuration");
}

const resolvedHref = resolveUrl(download.href);
const externalLink = isExternalUrl(download.href);
const sanitizedHref = download.href?.split("#")[0]?.split("?")[0] ?? download.href;
const derivedDownloadName = download.name ?? sanitizedHref.split("/").filter(Boolean).pop();
const downloadAttr = !externalLink ? derivedDownloadName ?? undefined : undefined;
const resolvedMedia = media
  ? {
      ...media,
      src: resolveUrl(media.src),
    }
  : null;

const toKey = (value: string) =>
  value
    .split(/[-_]/)
    .map((part) => part.charAt(0).toUpperCase() + part.slice(1))
    .join("");

const sectionClassName = [
  styles.section,
  styles[`theme${toKey(theme)}` as keyof typeof styles],
  styles[`align${toKey(align)}` as keyof typeof styles],
]
  .filter(Boolean)
  .join(" ");
---

<section class={`${sectionClassName} section-container`}>
  <div class={styles.shell}>
    {resolvedMedia && (
      <div class={styles.media}>
        <img src={resolvedMedia.src} alt={resolvedMedia.alt ?? title ?? download.label} loading="lazy" />
      </div>
    )}
    <div class={styles.content}>
      {title && <h2>{title}</h2>}
      {description && <p class={styles.description} set:html={description} />}
      {note && <p class={styles.note}>{note}</p>}
      <a
        class={styles.action}
        href={resolvedHref}
        target={externalLink ? "_blank" : undefined}
        rel={externalLink ? "noopener noreferrer" : undefined}
        download={downloadAttr}
      >
        {download.label}
      </a>
    </div>
  </div>
</section>
