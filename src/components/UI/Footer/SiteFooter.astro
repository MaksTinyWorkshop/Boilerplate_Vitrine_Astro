---
import ActionButton from "@components/CTAs/ActionButton/ActionButton.astro";
import type { SiteConfig } from "@lib/siteData";
import { getSiteConfig } from "@lib/siteData";
import {
  DEFAULT_LOCALE,
  isInternalHref,
  localizePath,
  type Locale,
} from "@lib/i18n/locales";
import { resolveUrl } from "@lib/urlHelpers";
import styles from "./footer.module.scss";
import Spacer from "../Spacer.astro";

interface SiteFooterProps {
  site?: SiteConfig;
  locale?: Locale;
}

const { site, locale = DEFAULT_LOCALE } = Astro.props as SiteFooterProps;

const siteContent = site ?? getSiteConfig(locale);

const year = new Date().getFullYear();

const secondaryLogo = siteContent.brand.logos[1];
const secondaryLogoSrc = secondaryLogo
  ? resolveUrl(secondaryLogo.src)
  : "";
const primaryAction = siteContent.contact.primaryAction
  ? {
      ...siteContent.contact.primaryAction,
      href: isInternalHref(siteContent.contact.primaryAction.href)
        ? resolveUrl(localizePath(siteContent.contact.primaryAction.href, locale))
        : siteContent.contact.primaryAction.href,
    }
  : undefined;
const companyName =
  siteContent.legal.companyName || siteContent.brand.name;
const footerLinks = [
  ...siteContent.navigation.footer,
  ...siteContent.legal.links,
].filter(
  (link, index, array) =>
    array.findIndex((candidate) => candidate.href === link.href) === index
);
const footerSignature =
  siteContent.footer?.signature ??
  (siteContent.language === "en"
    ? "Showcase site powered by Astro."
    : "Site vitrine propulsé par Astro.");

const resolveLinkHref = (href: string) =>
  isInternalHref(href)
    ? resolveUrl(localizePath(href, locale))
    : href;
---

<footer class={styles.footer}>
  <div class={styles.logo} aria-hidden="true">
    {
      secondaryLogoSrc && (
        <img
          src={secondaryLogoSrc}
          alt={secondaryLogo?.alt ?? "Logo secondaire"}
          loading="lazy"
        />
      )
    }
  </div>

  {
    primaryAction && (
      <ActionButton
        label={primaryAction.label}
        href={primaryAction.href}
        icon={primaryAction.icon}
      />
    )
  }

  {
    footerLinks.length > 0 && (
      <div class={styles.cgv_legals}>
        {footerLinks.map((link, index) => (
          <span class={styles.linkWrapper}>
            <a class={styles.link} href={resolveLinkHref(link.href)}>
              {link.label}
            </a>
            {index < footerLinks.length - 1 && (
              <Spacer size="1rem" axis="horizontal" />
            )}
          </span>
        ))}
      </div>
    )
  }
  <p class={styles.copyright}>
    © {year} {companyName}. {footerSignature}
  </p>
</footer>
